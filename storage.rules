rules_version = '2';

// Firebase Storage Rules for ViewTrack
// Controls access to thumbnails and profile pictures stored in Firebase Storage

service firebase.storage {
  match /b/{bucket}/o {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if user is a member of the organization
    // Note: We can't directly access Firestore from Storage rules,
    // so we use a simpler check here based on the path structure
    function isOrgPath(orgId) {
      return isSignedIn();
      // In production, consider using custom claims or tokens to verify org membership
    }
    
    // Check if file is an image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Check if file size is reasonable (max 10MB for images)
    function isReasonableSize() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // ==================== ORGANIZATION STORAGE ====================
    
    // All organization data stored under organizations/{orgId}/
    // ==================== USER ORG LOGOS ====================
    
    // User organization logos: users/{userId}/org-logos/{imageName}
    match /users/{userId}/org-logos/{imageName} {
      // Owner can upload their org logos
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && isImage() 
        && isReasonableSize();
      
      // Public read for org logos
      allow read: if true;
      
      // Owner can delete their org logos
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // ==================== USER PROFILE PHOTOS ====================
    
    // User profile photos: profile-photos/{userId}/{imageName}
    match /profile-photos/{userId}/{imageName} {
      // Owner can upload their profile photos
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && isImage() 
        && isReasonableSize();
      
      // Public read for profile photos (needed for display)
      allow read: if true;
      
      // Owner can delete their profile photos
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    match /organizations/{orgId}/{allPaths=**} {
      
      // ==================== THUMBNAILS ====================
      
      // Video thumbnails: organizations/{orgId}/thumbnails/{videoId}.jpg
      match /thumbnails/{videoId} {
        // Any authenticated user can read thumbnails
        // (thumbnails are not sensitive data)
        allow read: if isSignedIn();
        
        // Only org members can upload thumbnails
        allow write: if isOrgPath(orgId) 
          && isImage() 
          && isReasonableSize();
        
        // Only org members can delete thumbnails
        allow delete: if isOrgPath(orgId);
      }
      
      // ==================== PROFILE PICTURES ====================
      
      // Profile pictures: organizations/{orgId}/profiles/{accountId}.jpg
      match /profiles/{accountId} {
        // Any authenticated user can read profile pictures
        allow read: if isSignedIn();
        
        // Only org members can upload profile pictures
        allow write: if isOrgPath(orgId) 
          && isImage() 
          && isReasonableSize();
        
        // Only org members can delete profile pictures
        allow delete: if isOrgPath(orgId);
      }
      
      // ==================== PROJECT IMAGES ====================
      
      // Project images: organizations/{orgId}/projects/{imageName}
      match /projects/{imageName} {
        // Public read for project images
        allow read: if true;
        
        // Only org members can upload project images
        allow write: if isOrgPath(orgId) 
          && isImage() 
          && isReasonableSize();
        
        // Only org members can delete project images
        allow delete: if isOrgPath(orgId);
      }
    }
    
    // ==================== DEFAULT DENY ====================
    
    // Deny all other access by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

