rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if user is the document owner
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Get organization member data
    function getOrgMember(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data;
    }
    
    // Check if user is a member of the organization
    function isOrgMember(orgId) {
      return isSignedIn() 
        && exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
        && getOrgMember(orgId).status == 'active';
    }
    
    // Check if user has specific role or higher
    function hasOrgRole(orgId, role) {
      let member = getOrgMember(orgId);
      return isOrgMember(orgId) && (
        role == 'member' ||
        (role == 'admin' && member.role in ['admin', 'owner']) ||
        (role == 'owner' && member.role == 'owner')
      );
    }
    
    // Check if organization is a demo org (public access)
    function isDemoOrg(orgId) {
      return orgId == 'Vx2UpxGCV3uD8Xj2ioX4';
    }
    
    // Check if user can read org data
    function canReadOrg(orgId) {
      return isOrgMember(orgId) || isDemoOrg(orgId);
    }
    
    // Check if user can write org data (all members can write)
    function canWriteOrg(orgId) {
      return hasOrgRole(orgId, 'member');
    }
    
    // Check if user can manage org (admin actions only)
    function canManageOrg(orgId) {
      return hasOrgRole(orgId, 'admin');
    }
    
    // Check if user is admin or owner
    function isOrgAdmin(orgId) {
      return hasOrgRole(orgId, 'admin');
    }
    
    // Check if update is only modifying counter fields
    function onlyUpdatingCounters() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly([
        'linkCount', 
        'videoCount', 
        'trackedAccountCount',
        'updatedAt'
      ]);
    }
    
    // Check if creator is linked to an account
    function isCreatorLinkedToAccount(orgId, accountId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/creatorLinks/$(request.auth.uid + '_' + accountId));
    }
    
    // Get user's role in organization
    function getUserRole(orgId) {
      return getOrgMember(orgId).role;
    }
    
    // ==================== USER ACCOUNTS ====================
    
    // Check if the requesting user is in any shared organization with the target user
    function isInSharedOrg(targetUserId) {
      // This is a simplified check - in practice, Firestore will allow reads
      // if users share at least one organization membership
      return isSignedIn();
    }
    
    // Users can access their own account, and other authenticated users can read
    // basic profile info (displayName, photoURL) for team members
    match /users/{userId} {
      // Full read access to own profile
      // Basic profile access (displayName, photoURL) for authenticated users
      allow read: if isOwner(userId) || isSignedIn();
      
      // Only owner can write
      allow write: if isOwner(userId);
      
      // User preferences
      match /preferences/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ==================== ORGANIZATIONS ====================
    
    match /organizations/{orgId} {
      // Can read if member OR if demo org (public access)
      allow read: if canReadOrg(orgId) || isDemoOrg(orgId);
      
      // Can create if signed in (becomes owner automatically)
      // Allow batch writes for creating org + initial member in same transaction
      allow create: if isSignedIn() 
        && request.resource.data.ownerUserId == request.auth.uid
        && request.resource.data.createdBy == request.auth.uid;
      
      // Can update if admin (or if creating initial state with batch write)
      allow update: if canManageOrg(orgId) 
        || (isSignedIn() && request.resource.data.ownerUserId == request.auth.uid);
      
      // Can delete if owner
      allow delete: if hasOrgRole(orgId, 'owner');
      
      // ==================== ORG MEMBERS ====================
      
      match /members/{userId} {
        // Members can read member list, OR users can read their own member doc
        allow read: if canReadOrg(orgId) || (isSignedIn() && isOwner(userId));
        
        // Admins can manage members, OR user can create themselves
        // Note: Application logic validates invitations before member creation
        allow create: if canManageOrg(orgId) 
          || (isSignedIn() && isOwner(userId));
        
        // Admins can update members
        // Users can update their own member doc if they're active members
        // Users can also reactivate their own removed membership (for invitation acceptance)
        allow update: if canManageOrg(orgId) 
          || (isOwner(userId) && isOrgMember(orgId))
          || (isOwner(userId) && isSignedIn());
        
        // Owner can delete members, members can remove themselves
        allow delete: if hasOrgRole(orgId, 'owner') || isOwner(userId);
      }
      
      // ==================== TEAM INVITATIONS ====================
      
      match /invitations/{invitationId} {
        // Members can read invitations (to see pending invites)
        // Invited users can read their own invitations by email
        allow read: if canReadOrg(orgId) 
          || (isSignedIn() && request.auth.token.email == resource.data.email);
        
        // Only admins can create invitations
        allow create: if canManageOrg(orgId) 
          && request.resource.data.orgId == orgId
          && request.resource.data.invitedBy == request.auth.uid;
        
        // Admins can update/cancel invitations
        // Invited users can update to accept/decline their own invitation
        allow update: if canManageOrg(orgId)
          || (isSignedIn() && request.auth.token.email == resource.data.email && resource.data.status == 'pending');
        
        // Admins can delete invitations
        // Invited users can delete their own invitation after accepting (for cleanup)
        allow delete: if canManageOrg(orgId)
          || (isSignedIn() && request.auth.token.email == resource.data.email);
      }
      
      // Alternative path for team invitations (same rules as above)
      match /teamInvitations/{invitationId} {
        // Members can read invitations (to see pending invites)
        // Invited users can read their own invitations by email
        allow read: if canReadOrg(orgId) 
          || (isSignedIn() && request.auth.token.email == resource.data.email);
        
        // Only admins can create invitations
        allow create: if canManageOrg(orgId) 
          && request.resource.data.orgId == orgId
          && request.resource.data.invitedBy == request.auth.uid;
        
        // Admins can update/cancel invitations
        // Invited users can update to accept/decline their own invitation
        allow update: if canManageOrg(orgId)
          || (isSignedIn() && request.auth.token.email == resource.data.email && resource.data.status == 'pending');
        
        // Admins can delete invitations
        // Invited users can delete their own invitation after accepting (for cleanup)
        allow delete: if canManageOrg(orgId)
          || (isSignedIn() && request.auth.token.email == resource.data.email);
      }
      
      // ==================== ORG SETTINGS ====================
      
      match /settings/{document=**} {
        allow read: if canReadOrg(orgId);
        allow write: if canManageOrg(orgId);
      }
      
      // ==================== BILLING & SUBSCRIPTION ====================
      
      match /billing/{document=**} {
        // Members can read subscription info
        allow read: if canReadOrg(orgId);
        
        // Only admins can update subscription (or server via Admin SDK)
        allow write: if canManageOrg(orgId);
      }
      
      // ==================== PROJECTS ====================
      
      match /projects/{projectId} {
        // Members can read their org's projects
        allow read: if canReadOrg(orgId);
        
        // Members can create projects
        allow create: if canWriteOrg(orgId) 
          && request.resource.data.orgId == orgId
          && request.resource.data.createdBy == request.auth.uid;
        
        // Admins can update any project fields
        // Members can only update stat counters (linkCount, videoCount, etc.) when creating resources
        allow update: if canManageOrg(orgId)
          || (canWriteOrg(orgId) && onlyUpdatingCounters());
        
        // Only admins can delete projects
        allow delete: if canManageOrg(orgId);
        
        // ==================== PROJECT STATS ====================
        
        match /stats/{statId} {
          allow read: if canReadOrg(orgId);
          allow write: if canManageOrg(orgId);
        }
        
        // ==================== PROJECT TRACKED ACCOUNTS ====================
        
        match /trackedAccounts/{accountId} {
          // All org members can read tracked accounts
          // App logic filters accounts for creators based on creatorLinks
          allow read: if canReadOrg(orgId);
          
          // All members can create accounts (but not creators)
          allow create: if canWriteOrg(orgId) 
            && request.resource.data.addedBy == request.auth.uid
            && getUserRole(orgId) != 'creator';
          
          // Only admins can update/delete accounts
          allow update, delete: if canManageOrg(orgId);
          
          match /videos/{videoId} {
            // All org members can read videos
            // App logic filters videos for creators based on linked accounts
            allow read: if canReadOrg(orgId);
            
            // All members can create videos (but not creators)
            allow create: if canWriteOrg(orgId) && getUserRole(orgId) != 'creator';
            
            // Only admins can update/delete videos
            allow update, delete: if canManageOrg(orgId);
          }
        }
        
        // ==================== PROJECT LINKS ====================
        
        match /links/{linkId} {
          // All members can read
          allow read: if canReadOrg(orgId);
          
          // All members can create links
          allow create: if canWriteOrg(orgId) 
            && request.resource.data.createdBy == request.auth.uid;
          
          // Only admins can update/delete links
          allow update, delete: if canManageOrg(orgId);
          
          match /clicks/{clickId} {
            // All members can read analytics
            allow read: if canReadOrg(orgId);
            
            // Public API can create click events (via redirect handler)
            allow create: if true;
            
            // Clicks are immutable
            allow update, delete: if false;
          }
        }
        
        // ==================== PROJECT VIDEOS ====================
        
        match /videos/{videoId} {
          // All members can read
          allow read: if canReadOrg(orgId);
          
          // All members can create videos
          allow create: if canWriteOrg(orgId);
          
          // Only admins can update/delete videos
          allow update, delete: if canManageOrg(orgId);
          
          // ==================== VIDEO SNAPSHOTS ====================
          
          match /snapshots/{snapshotId} {
            // All members can read snapshots
            allow read: if canReadOrg(orgId);
            
            // All members can create snapshots (for manual refresh)
            // Cloud Functions can also create (via Admin SDK, bypasses rules)
            allow create: if canWriteOrg(orgId);
            
            // Only admins can delete snapshots (when deleting parent video)
            // Snapshots cannot be updated (immutable after creation)
            allow update: if false;
            allow delete: if canManageOrg(orgId);
          }
        }
        
        // ==================== PROJECT TRACKING RULES ====================
        
        match /trackingRules/{ruleId} {
          // All members can read rules
          allow read: if canReadOrg(orgId);
          
          // All members can create rules
          allow create: if canWriteOrg(orgId) 
            && request.resource.data.organizationId == orgId
            && request.resource.data.projectId == projectId
            && request.resource.data.createdBy == request.auth.uid;
          
          // Only admins can update/delete rules
          allow update, delete: if canManageOrg(orgId);
        }
        
        // Alternative path for rules (same as trackingRules)
        match /rules/{ruleId} {
          // All members can read rules
          allow read: if canReadOrg(orgId);
          
          // All members can create rules
          allow create: if canWriteOrg(orgId);
          
          // Only admins can update/delete rules
          allow update, delete: if canManageOrg(orgId);
        }
        
        // ==================== USER PREFERENCES (PER PROJECT) ====================
        
        match /userPreferences/{userId} {
          // Users can read their own preferences
          allow read: if isOwner(userId) && canReadOrg(orgId);
          
          // Users can write their own preferences
          allow write: if isOwner(userId) && canWriteOrg(orgId);
        }
        
        // ==================== CAMPAIGNS ====================
        
        match /campaigns/{campaignId} {
          // All members can read campaigns
          allow read: if canReadOrg(orgId);
          
          // Only admins/managers can create campaigns
          allow create: if canManageOrg(orgId) 
            && request.resource.data.organizationId == orgId
            && request.resource.data.projectId == projectId
            && request.resource.data.createdBy == request.auth.uid;
          
          // Only admins/managers can update/delete campaigns
          allow update, delete: if canManageOrg(orgId);
          
          // ==================== CAMPAIGN RESOURCES ====================
          
          match /resources/{resourceId} {
            // All members can read resources
            allow read: if canReadOrg(orgId);
            
            // Admins can create resources
            allow create: if canManageOrg(orgId) 
              && request.resource.data.uploadedBy == request.auth.uid;
            
            // Admins can update resources (for download count tracking)
            // Also allow anyone to increment downloadCount
            allow update: if canManageOrg(orgId)
              || (canReadOrg(orgId) && 
                  request.resource.data.diff(resource.data).affectedKeys().hasOnly(['downloadCount']));
            
            // Only admins can delete resources
            allow delete: if canManageOrg(orgId);
          }
          
          // ==================== CAMPAIGN VIDEO SUBMISSIONS ====================
          
          match /videoSubmissions/{submissionId} {
            // All members can read video submissions
            allow read: if canReadOrg(orgId);
            
            // Campaign participants can create submissions
            // Admins can also create submissions
            allow create: if canWriteOrg(orgId) 
              && request.resource.data.submittedBy == request.auth.uid;
            
            // Only admins or the submitter can update their submissions
            allow update: if canManageOrg(orgId) 
              || (isSignedIn() && resource.data.submittedBy == request.auth.uid);
            
            // Only admins can delete submissions
            allow delete: if canManageOrg(orgId);
          }
        }
        
        // ==================== PROJECT LINK CLICKS (AGGREGATED) ====================
        
        match /linkClicks/{clickId} {
          // All members can read aggregated click data
          allow read: if canReadOrg(orgId);
          
          // Public API or system can create clicks
          allow create: if true;
          
          // Clicks are immutable
          allow update, delete: if false;
        }
        
        // ==================== PROJECT REVENUE INTEGRATIONS ====================
        
        match /revenueIntegrations/{integrationId} {
          // All members can read revenue integrations
          allow read: if canReadOrg(orgId);
          
          // Admins can manage integrations
          allow create: if canManageOrg(orgId) 
            && request.resource.data.organizationId == orgId
            && request.resource.data.projectId == projectId;
          
          allow update: if canManageOrg(orgId);
          allow delete: if canManageOrg(orgId);
        }
        
        match /revenueTransactions/{transactionId} {
          // All members can read transactions
          allow read: if canReadOrg(orgId);
          
          // System/admins can create transactions
          allow create: if canManageOrg(orgId);
          
          // Transactions are immutable after creation
          allow update, delete: if false;
        }
        
        match /revenueMetrics/{metricsId} {
          // All members can read metrics
          allow read: if canReadOrg(orgId);
          
          // System/admins can write metrics
          allow create, update: if canManageOrg(orgId);
          allow delete: if canManageOrg(orgId);
        }
        
        match /revenueSnapshots/{snapshotId} {
          // All members can read snapshots
          allow read: if canReadOrg(orgId);
          
          // System/admins can create snapshots
          allow create: if canManageOrg(orgId);
          
          // Snapshots are immutable
          allow update, delete: if false;
        }
        
        match /revenueAttributions/{attributionId} {
          // All members can read attributions
          allow read: if canReadOrg(orgId);
          
          // System/admins can manage attributions
          allow create, update, delete: if canManageOrg(orgId);
        }
        
        // ==================== PROJECT CREATOR LINKS ====================
        
        match /creatorLinks/{linkId} {
          // All org members can read creator links (for viewing who's linked to accounts)
          // Note: resource.data check only works for get, not list queries
          allow read: if canReadOrg(orgId);
          
          // Only admins can create/manage creator links
          allow create, update, delete: if canManageOrg(orgId);
        }
        
        // ==================== PROJECT PAYOUT STRUCTURES ====================
        
        match /payoutStructures/{structureId} {
          // All org members can read payout structures
          allow read: if canReadOrg(orgId);
          
          // Only admins can create/update/delete payout structures
          allow write: if canManageOrg(orgId);
        }
        
        // ==================== DELETED VIDEOS BLACKLIST ====================
        
        match /deletedVideos/{platformVideoId} {
          // All org members can read blacklist (for UI checks)
          allow read: if canReadOrg(orgId);
          
          // Admins can write to blacklist (when deleting videos)
          // Also allow system/cron to check blacklist
          allow create: if canManageOrg(orgId);
          allow delete: if canManageOrg(orgId);
        }
        
        // ==================== PROJECT CREATOR PROFILES ====================
        
        match /creators/{creatorId} {
          // Admins can read all creator profiles in this project
          // All org members can read creator profiles (for viewing creator info)
          // Creators can read their own profile in this project
          allow read: if canReadOrg(orgId);
          
          // Admins can write any creator profile
          // Users can create their own creator profile (during invitation acceptance)
          allow create: if canManageOrg(orgId) || (isSignedIn() && request.auth.uid == creatorId);
          
          // Only admins can update/delete creator profiles
          allow update, delete: if canManageOrg(orgId);
          
          // ==================== PROJECT CREATOR PAYOUTS ====================
          
          match /payouts/{payoutId} {
            // Admins can read all payouts
            // Creators can read their own payouts (using resource.data for individual reads)
            allow read: if canManageOrg(orgId) || (isOrgMember(orgId) && resource != null && resource.data.creatorId == request.auth.uid);
            
            // Allow list operations for all org members (filtered by app logic)
            allow list: if canReadOrg(orgId);
            
            // Only admins can write payouts
            allow write: if canManageOrg(orgId);
          }
        }
      }
      
      // ==================== TRACKED ACCOUNTS (Legacy - for migration) ====================
      
      match /trackedAccounts/{accountId} {
        // All org members can read tracked accounts (legacy location)
        // App logic filters accounts for creators based on creatorLinks
        allow read: if canReadOrg(orgId);
        
        // All members can create accounts (but not creators)
        allow create: if canWriteOrg(orgId) 
          && request.resource.data.orgId == orgId
          && request.resource.data.addedBy == request.auth.uid
          && getUserRole(orgId) != 'creator';
        
        // Only admins can update/delete accounts
        allow update, delete: if canManageOrg(orgId);
      }
      
      // ==================== VIDEOS ====================
      
      match /videos/{videoId} {
        // All org members can read videos (legacy location)
        // App logic filters videos for creators based on linked accounts
        allow read: if canReadOrg(orgId);
        
        // All members can create videos (but not creators)
        allow create: if canWriteOrg(orgId) 
          && request.resource.data.orgId == orgId
          && request.resource.data.addedBy == request.auth.uid
          && getUserRole(orgId) != 'creator';
        
        // Only admins can update/delete videos
        allow update, delete: if canManageOrg(orgId);
        
        // ==================== VIDEO SNAPSHOTS ====================
        
        match /snapshots/{snapshotId} {
          // All members can read snapshots
          allow read: if canReadOrg(orgId);
          
          // All members can create snapshots (for manual refresh)
          // Cloud Functions can also create (via Admin SDK, bypasses rules)
          allow create: if canWriteOrg(orgId) 
            && request.resource.data.capturedBy == request.auth.uid;
          
          // Only admins can delete snapshots (when deleting parent video)
          // Snapshots cannot be updated (immutable after creation)
          allow update: if false;
          allow delete: if canManageOrg(orgId);
        }
      }
      
      // ==================== TRACKED LINKS ====================
      
      match /links/{linkId} {
        // All members can read
        allow read: if canReadOrg(orgId);
        
        // All members can create links
        allow create: if canWriteOrg(orgId) 
          && request.resource.data.orgId == orgId
          && request.resource.data.createdBy == request.auth.uid;
        
        // Allow public API to update click stats (for redirect tracking)
        // Only allows incrementing totalClicks and updating lastClickedAt
        allow update: if canManageOrg(orgId) 
          || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['totalClicks', 'lastClickedAt']));
        
        // Only admins can delete links
        allow delete: if canManageOrg(orgId);
        
        // ==================== LINK CLICKS ====================
        
        match /clicks/{clickId} {
          // All members can read click analytics
          allow read: if canReadOrg(orgId);
          
          // Public API can create click events (via redirect handler)
          allow create: if true;
          
          // Clicks are immutable
          allow update, delete: if false;
        }
      }
    }
    
    // ==================== PUBLIC LINK REDIRECTS ====================
    
    // Public collection for link shortcode -> orgId/linkId lookup
    // This allows unauthenticated users to resolve short links
    match /publicLinks/{shortCode} {
      allow read: if true; // Public read for redirects
      allow create: if isSignedIn(); // Authenticated users can create
      allow update, delete: if false; // Immutable after creation
    }
    
    // ==================== INVITATION LOOKUP ====================
    
    // Public collection for invitation lookups
    // Allows users to access invitation details before authentication
    match /invitationsLookup/{invitationId} {
      allow read: if true; // Public read for invitation portal
      allow create: if isSignedIn(); // Created when invitations are sent
      allow update: if isSignedIn(); // Allow updates when invitation is accepted/declined
      allow delete: if isSignedIn(); // Allow admins to delete cancelled invitations
    }
    
    // ==================== COLLECTION GROUP QUERIES ====================
    
    // Allow users to query their own memberships across all organizations
    match /{path=**}/members/{memberId} {
      allow read: if isSignedIn() && 
        (request.auth.uid == memberId || 
         resource.data.userId == request.auth.uid);
    }
    
    // Allow users to query their own invitations across all organizations
    match /{path=**}/invitations/{invitationId} {
      allow read: if isSignedIn() && 
        request.auth.token.email == resource.data.email;
    }
    
    // Shareable Contracts - Public access for signing
    match /shareableContracts/{contractId} {
      // Anyone can read a contract with the link (public access)
      allow read: if true;
      
      // Organization members can create contracts
      allow create: if isSignedIn();
      
      // Anyone can update to sign the contract (add signatures)
      // But can only update signature fields, not other contract details
      allow update: if true &&
        (
          // Allow updating creator signature
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['creatorSignature', 'updatedAt', 'status'])) ||
          // Allow updating company signature
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['companySignature', 'updatedAt', 'status']))
        );
      
      // Only organization members can delete
      allow delete: if isSignedIn();
    }
    
    // ==================== CONTRACT TEMPLATES ====================
    
    // Contract templates for reusable contract terms
    match /contractTemplates/{templateId} {
      // All authenticated users can read templates
      allow read: if isSignedIn();
      
      // Users can create templates for their organization
      allow create: if isSignedIn() 
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.organizationId is string;
      
      // Users can update their own templates
      allow update: if isSignedIn() 
        && resource.data.createdBy == request.auth.uid;
      
      // Users can delete their own templates
      allow delete: if isSignedIn() 
        && resource.data.createdBy == request.auth.uid;
    }
  }
}

